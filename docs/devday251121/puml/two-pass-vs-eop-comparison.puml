@startuml Two-Pass vs EOP Comparison
!theme plain
skinparam backgroundColor #FEFEFE
skinparam roundcorner 10
skinparam shadowing false

title Decomposition Engines Comparison\nTwo-Pass vs Execute-Observe-Plan (EOP)

' Define colors
!define TWOPASS_COLOR
!define EOP_COLOR
!define PROBLEM_COLOR
!define SUCCESS_COLOR

|Two-Pass Decomposition|
start

:YAML Input
(user-login: "Click login dropdown");

:Launch Browser
Navigate to baseUrl;

:Extract HTML **ONCE**;
note right
  ğŸ“„ HTML Size: 105,930 chars
  âš ï¸ Login dropdown is **CLOSED**
  âŒ Email/password fields **NOT VISIBLE**
end note

partition "Pass 1: Planning" {
  :Send HTML to LLM
  "Create execution plan";

  :LLM analyzes **stale HTML**;

  :Generate plan:
  1. Click login dropdown
  2. Wait for form
  3. Enter email
  4. Enter password
  5. Click submit;
}

partition "Pass 2: Command Generation" {
  repeat
    :Generate command for step
    using **STALE HTML**;

    note right
    background
      âš ï¸ Problem: HTML never refreshed!
      LLM can't see email/password fields
      that only appear after clicking dropdown
    end note

    :LLM generates command
    (guesses selector);

    backward:Parse command;
  repeat while (More steps?) is (yes)
  ->no;
}

partition "Pass 3: Validation" {
  repeat
    :Validate command
    against **STALE HTML**;

    if (Selector found?) then (yes)
     :âœ… Valid;
    else (no)
     :âŒ Failed
      "input[type=password] not found";

      :LLM: Refine selector
      using **STALE HTML**;

      :Attempt 2/3;

      if (Found now?) then (no)
        :Attempt 3/3;

        if (Found now?) then (no)
         :âš ï¸ Max attempts
          Use last selector anyway;
        endif
      endif
    endif
  repeat while (More commands?)
  ->done;
}

:Return Subtask
with ALL commands;

note right
  **Result:**
  âŒ 12 validation errors
  âŒ 50% wrong selectors
  âš ï¸ 18 refinement attempts
  ğŸ’° 27 LLM calls
end note

stop

|Execute-Observe-Plan (EOP)|
start

:YAML Input
(user-login: "Click login dropdown");

:Launch Browser
Navigate to baseUrl;

partition "EOP Loop" {
  repeat

    :OBSERVE
    Extract **FRESH HTML**;

    note right
      ğŸ“„ HTML reflects
      **current page state**
    end note

    if (Iteration) then (1)
      note right
        HTML: 105,930 chars
        Dropdown: CLOSED
      end note
    elseif (2)
      note right
    background
        HTML: 110,049 chars â†‘
        Dropdown: **OPENED**
        âœ… Email field **VISIBLE**
        âœ… Password field **VISIBLE**
      end note
    endif

    :PLAN
    Generate **ONE command**
    using fresh HTML;

    :LLM sees actual page state;

    if (Iteration) then (1)
      :Generated:
      click text=Anmelden;
      note right
        âœ… Dropdown button visible
        âœ… Correct selector
      end note
    elseif (2)
      :Generated:
      type placeholder=E-Mail-Adresse;
      note right
    background
        âœ… Email field NOW visible in HTML!
        âœ… Correct placeholder
      end note
    elseif (3)
      :Generated:
      type placeholder=Passwort;
      note right
    background
        âœ… Password field visible!
        âœ… Correct selector first try
      end note
    elseif (4)
      :Generated:
      click text=Anmelden;
    else (5)
      :Generated:
      wait (completion signal);
    endif

    if (Command is 'wait' and commands > 0?) then (yes)
     :Stop - Task complete;
      detach
    endif

    :EXECUTE
    Run command on browser;

    if (Iteration) then (1)
      :Click dropdown button;
      note right
        **Page state changed!**
        Dropdown opened
        Form now visible
      end note
    elseif (2)
      :Type into email field;
    elseif (3)
      :Type into password field;
    elseif (4)
      :Click submit button;
    endif

    :Wait 500ms
    (DOM stabilization);

  repeat while (< 10 iterations?) is (yes)
  ->no;
}

:Return Subtask
with commands;

note right
  **Result:**
  âœ… 0 validation errors
  âœ… 100% correct selectors
  âœ… 0 refinement attempts
  ğŸ’° 5 LLM calls (-81%)
end note

stop

legend bottom
  **Key Differences:**

  |= Aspect |= Two-Pass |= EOP |
  | HTML Freshness | âŒ Captured once (stale) | âœ… Refreshed each iteration |
  | Sees Dynamic Content | âŒ No | âœ… Yes |
  | Validation Errors | âŒ Many (12) | âœ… None (0) |
  | LLM Calls | âŒ 27 | âœ… 5 (-81%) |
  | Selector Accuracy | âŒ 50% | âœ… 100% |
  | Handles Dropdowns | âŒ No | âœ… Yes |
  | Handles Modals | âŒ No | âœ… Yes |
  | Production Ready | âš ï¸ Limited | âœ… Yes |
end legend

@enduml
