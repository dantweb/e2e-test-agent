# Docker Compose for running tests in isolated environment
version: '3.8'

services:
  test-runner:
    build:
      context: .
      dockerfile: Dockerfile.test
    environment:
      # LLM API Configuration
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://api.openai.com/v1}

      # Test Configuration
      - NODE_ENV=test
      - CI=true

      # Playwright Configuration
      - PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
      - HEADLESS=true

    volumes:
      # Mount source code for live updates during development
      - ./src:/app/src:ro
      - ./tests:/app/tests:ro

      # Mount output directory for generated files
      - ./reports:/app/reports
      - ./_generated:/app/_generated

      # Mount test fixtures
      - ./tests/fixtures:/app/tests/fixtures:ro

    working_dir: /app

    # Override default CMD to run specific test suites
    command: npm test

    # Resource limits (optional - adjust based on your needs)
    mem_limit: 2g
    cpus: 2

  # Service for running integration tests (with real LLM)
  integration-test:
    build:
      context: .
      dockerfile: Dockerfile.test
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://api.openai.com/v1}
      - NODE_ENV=test
      - HEADLESS=true
    volumes:
      - ./src:/app/src:ro
      - ./tests:/app/tests:ro
      - ./reports:/app/reports
      - ./_generated:/app/_generated
    working_dir: /app
    command: npm run test:integration

  # Service for running unit tests (fast, no real LLM calls)
  unit-test:
    build:
      context: .
      dockerfile: Dockerfile.test
    environment:
      - NODE_ENV=test
    volumes:
      - ./src:/app/src:ro
      - ./tests:/app/tests:ro
      - ./reports:/app/reports
    working_dir: /app
    command: npm run test:unit

  # Service for running E2E test generation
  e2e-generator:
    build:
      context: .
      dockerfile: Dockerfile.test
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4}
      - NODE_ENV=test
      - HEADLESS=true
    volumes:
      - ./src:/app/src:ro
      - ./tests:/app/tests:ro
      - ./_generated:/app/_generated
      - ./bin:/app/bin:ro
    working_dir: /app
    command: npm run build && node dist/cli.js tests/realworld/paypal.yaml --verbose
